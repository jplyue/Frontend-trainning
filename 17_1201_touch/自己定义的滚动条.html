<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>方向锁定</title>
	<meta name="viewport" content="width=device-width,user-scalable=no">
	<style>
		* { margin: 0; padding: 0; list-style: none; }
		html{ font-size: 20px; }
		body{ overflow: hidden; }
		#banner{ width: 125rem; transform: translate(0px); overflow: hidden; }
		#banner li{ float: left; width: 25rem; height: 7.8rem;  }
		#wrap{ background: #ccc; }
		#content{ position: relative; top: -30px; background-color: #fff; overflow: hidden; z-index: 2;}
		.loadMore{ position: relative; text-align: center; line-height: 30px; z-index: 1; }
		.scroll_bar{ width: 0.3rem; height: 1.5rem; background: black; position: fixed; right: 0; top: 0; z-index: 999; opacity: .3; }
	</style>
	<script src="lib/jquery.min.js"></script>
	<script>
		window.onload = function(){
			//rem
			//rem/fontSize=rem2/fontSize
			document.documentElement.style.fontSize = document.documentElement.clientWidth*20/500+'px';

			//拖
			let banner = document.getElementById('banner');
			let content = document.getElementById('content');
			let banner_ul = banner.children[0];

			let loadMore = document.getElementsByClassName('loadMore')[0];

			let bar = document.getElementsByClassName('scroll_bar')[0];

			let banner_left = 0;
			let content_top = 0;

			function loadData(fn){
				$.ajax({
					url: 'a.txt',
					success: function(str){
						let arr = str.split('\n');

						$('ol').html('');
						arr.forEach(s=>{
							$(`<li>${s}</li>`).appendTo($('ol'));
						});

						fn&&fn();
					},
					error(){
						alert('加载失败')
					}
				})
			}

			loadData();
			//前面加一个

			//后面加一个


			banner.addEventListener('touchstart', function(ev){
				/*
				* 拖着特别费劲 —— 开始拖动的时候先清除
				*/
				banner_ul.style.transition = ``;
				content.style.transition = ``;

				let startX = ev.targetTouches[0].clientX;//起点
				let startY = ev.targetTouches[0].clientY;

				let dir = '';
				let disX = startX - banner_left;
				let disY = startY - content_top;

				function fnMove(ev){
					let x = ev.targetTouches[0].clientX;
					let y = ev.targetTouches[0].clientY;
					
					//阈值：5，哪个方向超出了5，认为就在那个方向移动
					//方向确定了你就不能改变了
					if(!dir){//方向待确定
						if(Math.abs(ev.targetTouches[0].clientX - startX) >= 5){//横向移动的距离
							dir = 'x';
						}else if(Math.abs(ev.targetTouches[0].clientY - startY) >= 5){
							dir = 'y';
						}
					}else{//方向已经确定
						if(dir == 'x'){//处理的是banner的移动
							banner_left = x - disX;
							banner_ul.style.transform = `translateX(${banner_left}px)`;
						}else if(dir == 'y'){//处理的是页面的移动
							content_top = y - disY;

							if(content_top > 0){
								content.style.transform = `translateY(${content_top/3}px)`;

								if(content_top >= 200){
									loadMore.innerHTML = '松开加载';
								}else{
									loadMore.innerHTML = '下拉刷新';
								}
							}else{


								content.style.transform = `translateY(${content_top}px)`;

								//自定义滑块
								//content的高度 - 屏幕的高度 = 页面可以滑动的区域大小
								//屏幕高度- 小滑块的高度 = 小滑块最多能滚动的高度
								bar.style.top = (document.documentElement.clientHeight - bar.offsetHeight) * -content_top / (content.offsetHeight - document.documentElement.clientHeight) + 'px';
							}
						}
					}
					
				}	

				function fnEnd(){
					banner.removeEventListener('touchmove', fnMove, false);
					banner.removeEventListener('touchend', fnEnd, false);

					//根据位移，判断显示第几张
					if(dir == 'x'){//banner
						let n = Math.round(-banner_left/banner_ul.children[0].offsetWidth);

						if(n<0){
							n = 0;
						}else if(n >= banner_ul.children.length){
							n = banner_ul.children.leng-1;
						}

						banner_left = -n*banner_ul.children[0].offsetWidth;
						/*
						* 拖着特别费劲
						*/
						banner_ul.style.transition = `0.7s all ease`;
						banner_ul.style.transform = `translateX(${banner_left}px)`;
					}else if(dir == 'y'){//content
						if(content_top >= 200){	//加载新数据
							content_top = 30;// loadmore的高度

							loadMore.innerHTML = '正在加载...';

							loadData(function(){
								loadMore.innerHTML = '下拉刷新...';
								content_top = 0;
								content.style.transition = `0.6s all ease`;
								content.style.transform = `translateY(${content_top}px)`;
							});
						}else{
							content_top = 0;
						}
						content.style.transition = `0.6s all ease`;
						content.style.transform = `translateY(${content_top}px)`;
					}
				}

				banner.addEventListener('touchmove', fnMove, false);
				banner.addEventListener('touchend', fnEnd, false);
				

			}, false)

		}
	</script>
</head>
<body>
	<div id="wrap">
		<div class="loadMore">下拉刷新</div>
		<div id="content">
			<div class="wrapper" id="banner">
				<ul >
					<li style="background: #FC0">1</li>
					<li style="background: #F0C">2</li>
					<li style="background: #0CF">3</li>
					<li style="background: #F0C">4</li>
					<li style="background: #0FC">5</li>
				</ul>
			</div>
			<ol id="ol1">
			</ol>
		</div>

	</div>
	<div class="scroll_bar"></div>
	
	
</body>
</html>